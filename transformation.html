<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Преобразование временных рядов - Аналитическая система</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <style>
        /* Улучшенные стили для страницы преобразования данных */
        .data-table {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background-color: #f1f5f9;
            padding: 14px 16px;
            text-align: left;
            font-weight: 500;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover td {
            background-color: #f8fafc;
        }
        
        .transformation-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .transformation-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .transformation-header {
            padding: 16px 20px;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transformation-header h3 {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
            color: #334155;
            display: flex;
            align-items: center;
        }
        
        .transformation-header h3 i {
            margin-right: 10px;
            color: #3b82f6;
        }
        
        .transformation-content {
            padding: 24px;
        }
        
        .variable-row {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        
        .variable-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .variable-name {
            flex: 1.2;
            font-weight: 500;
            color: #334155;
            display: flex;
            align-items: center;
        }
        
        .variable-status {
            flex: 0.8;
            color: #64748b;
            padding: 0 10px;
        }
        
        .transformation-options {
            flex: 1.5;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .select-wrapper {
            position: relative;
            flex: 1;
        }
        
        .select-wrapper select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background-color: #f8fafc;
            color: #334155;
            appearance: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .select-wrapper select:hover {
            border-color: #cbd5e1;
        }
        
        .select-wrapper select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .select-wrapper::after {
            content: '\f107';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            pointer-events: none;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        
        .transform-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #3b82f6;
        }
        
        .actions-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding: 16px 24px;
            background-color: #f8fafc;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .actions-panel:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .actions-panel .left-actions {
            display: flex;
            gap: 12px;
        }
        
        .actions-panel .right-actions {
            display: flex;
            gap: 12px;
        }
        
        .actions-panel .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 6px;
        }
        
        .actions-panel .btn-primary {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .actions-panel .btn-primary:hover {
            background-color: #2563eb;
            border-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
        }
        
        .actions-panel .btn-primary:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        
        .actions-panel .btn-secondary {
            background-color: #f1f5f9;
            border-color: #e2e8f0;
            color: #334155;
        }
        
        .actions-panel .btn-secondary:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .actions-panel .btn-secondary:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        
        .actions-panel .btn-danger {
            background-color: #ef4444;
            border-color: #ef4444;
            color: white;
        }
        
        .actions-panel .btn-danger:hover {
            background-color: #dc2626;
            border-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.2);
        }
        
        .actions-panel .btn-danger:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        
        #downloadBtn {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        #downloadBtn[style*="display: none"] {
            opacity: 0;
            transform: scale(0.9);
        }
        
        .alert-transformation {
            margin-top: 24px;
            border-left: 4px solid #3b82f6;
            padding: 16px 20px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .alert-transformation i {
            font-size: 20px;
            margin-right: 12px;
        }
        
        .file-info-panel {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            background-color: #eff6ff;
            border-radius: 8px;
            color: #334155;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .file-info-panel:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .file-info-panel i {
            font-size: 22px;
            color: #3b82f6;
        }
        
        .file-info-panel .file-actions {
            margin-left: auto;
        }
        
        .file-info-details strong {
            display: block;
            margin-bottom: 6px;
            font-size: 16px;
        }
        
        .file-info-details span {
            display: block;
            color: #64748b;
            font-size: 14px;
        }
        
        .no-data-message {
            text-align: center;
            padding: 48px 24px;
            background-color: #fef2f2;
            border-radius: 8px;
            margin-top: 24px;
            color: #b91c1c;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .no-data-message:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .no-data-message i {
            font-size: 36px;
            margin-bottom: 18px;
        }
        
        .no-data-message h4 {
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .status-badge.stationary {
            background-color: #ecfdf5;
            color: #059669;
        }
        
        .status-badge.non-stationary {
            background-color: #fff1f2;
            color: #e11d48;
        }
        
        .status-badge.normalized {
            background-color: #dbeafe;
            color: #3b82f6;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: #334155;
        }
        
        .chart-controls {
            display: flex;
            gap: 12px;
        }
        
        .chart-wrapper {
            height: 350px;
            width: 100%;
        }
        
        .transforms-info {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 18px 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .transforms-info:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .transforms-info h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #334155;
        }
        
        .transforms-info ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        
        .transforms-info li {
            position: relative;
            padding-left: 22px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #64748b;
        }
        
        .transforms-info li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: #3b82f6;
            font-weight: bold;
            font-size: 18px;
        }
        
        .transforms-info li:last-child {
            margin-bottom: 0;
        }
        
        .badge-transform {
            background-color: #f1f5f9;
            color: #475569;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-right: 4px;
        }
        
        .badge-stationarity {
            background-color: #dcfce7;
            color: #15803d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-right: 4px;
        }
        
        .badge-integration {
            background-color: #ffedd5;
            color: #c2410c;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-right: 4px;
        }
        
        .badge-extreme {
            background-color: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-right: 4px;
        }
        
        .display-toggle {
            margin-bottom: 16px;
            padding: 12px 16px;
            background-color: #f1f5f9;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .display-toggle:hover {
            background-color: #e2e8f0;
        }
        
        .display-toggle-label {
            font-weight: 500;
            color: #334155;
            margin-bottom: 8px;
            display: block;
        }
        
        .toggle-options {
            display: flex;
            gap: 12px;
        }
        
        .toggle-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .toggle-option input {
            margin-right: 6px;
            accent-color: #3b82f6;
        }
        
        .select-all-variables {
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            background-color: #f1f5f9;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .select-all-variables:hover {
            background-color: #e2e8f0;
        }
        
        .select-all-variables label {
            margin-left: 10px;
            font-weight: 500;
            color: #334155;
            cursor: pointer;
        }
        
        /* Для адаптивности на мобильных устройствах */
        @media (max-width: 767.98px) {
            .variable-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .variable-name, .variable-status, .transformation-options {
                width: 100%;
                flex: none;
                margin-bottom: 12px;
            }
            
            .transformation-options {
                flex-direction: column;
                gap: 12px;
            }
            
            .actions-panel {
                flex-direction: column;
                gap: 12px;
            }
            
            .actions-panel .left-actions,
            .actions-panel .right-actions {
                width: 100%;
                flex-direction: column;
            }
            
            .actions-panel .btn {
                width: 100%;
                justify-content: center;
            }
            
            .file-info-panel {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .file-info-panel .file-actions {
                margin-left: 0;
                margin-top: 12px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Верхняя панель -->
    <header class="top-panel">
        <div class="d-flex align-items-center">
            <button class="menu-toggle d-lg-none me-2" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo-container">
                <div class="logo-square"></div>
                <h1 class="app-title">Аналитическая система</h1>
            </div>
        </div>
        <nav class="top-menu">
            <ul>
                <li><a href="/contacts">Контакты</a></li>
            </ul>
        </nav>
    </header>

    <div class="main-container">
        <!-- Боковая панель -->
        <aside class="sidebar" id="sidebar">
            <nav class="main-nav">
                <ul>
                    <li>
                        <a href="/">
                            <span class="nav-icon"><i class="fas fa-home"></i></span>
                            Главная
                        </a>
                    </li>
                    <li class="active">
                        <a href="/data">
                            <span class="nav-icon"><i class="fas fa-database"></i></span>
                            Данные
                        </a>
                    </li>
                    <li>
                        <a href="/analysis">
                            <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                            Анализ
                        </a>
                    </li>
                    <li>
                        <a href="/forecasts">
                            <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                            Прогнозы
                        </a>
                    </li>
                    <li>
                        <a href="/reports">
                            <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                            Отчеты
                        </a>
                    </li>
                    <li>
                        <a href="/about">
                            <span class="nav-icon"><i class="fas fa-question-circle"></i></span>
                            О системе
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="version-info">
                <p>Версия 3.3.0</p>
                <p>Обновлено 10.05.2025</p>
            </div>
        </aside>

        <!-- Основной контент -->
        <main class="content">
            <div class="breadcrumbs">
                <span><a href="/">Главная</a></span>
                <span class="separator">/</span>
                <span><a href="/data">Данные</a></span>
                <span class="separator">/</span>
                <span>Преобразование временных рядов</span>
            </div>

            <div class="page-header">
                <h2>Преобразование временных рядов</h2>
                <p class="subtitle">Нормализация, стационаризация и трансформация данных для аналитики и моделирования</p>
            </div>

            <!-- Информация о загруженном файле (отображается, если файл загружен) -->
            <div id="fileInfoPanel" class="file-info-panel" style="display: none;">
                <i class="fas fa-file-excel"></i>
                <div class="file-info-details">
                    <strong id="fileName">Название файла</strong>
                    <span id="fileDetails">Информация о файле</span>
                </div>
                <div class="file-actions">
                    <button id="backToDataBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-chevron-left me-1"></i> К списку данных
                    </button>
                </div>
            </div>

            <!-- Сообщение, если нет загруженных данных -->
            <div id="noDataMessage" class="no-data-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Нет загруженных данных</h4>
                <p>Для преобразования временных рядов необходимо сначала загрузить файл с данными.</p>
                <a href="/data" class="btn btn-danger mt-2">
                    <i class="fas fa-upload me-2"></i>К загрузке данных
                </a>
            </div>

            <!-- Контент для преобразования данных (отображается, если файл загружен) -->
            <div id="transformationContent" style="display: none;">
                <!-- Информация о типах преобразований -->
                <div class="transforms-info">
                    <h4>Доступные типы преобразований</h4>
                    <ul>
                        <li><span class="badge-stationarity">Приведение к стационарности</span> - преобразование ряда любого порядка интегрирования к стационарному. </li>
                        <li><span class="badge-extreme">Экстремальная нормализация</span> - комплексное преобразование с использованием методов Box-Cox, Yeo-Johnson, ранговой нормализации для улучшения статистических свойств.</li>
                    </ul>
                </div>
                <div class="transforms-info">
                    <h4>Методы дифференцирования для интеграции</h4>
                    <ul>
                        <li><span class="badge-transform">Простое дифференцирование</span> - вычисление разности между последовательными наблюдениями.</li>
                        <li><span class="badge-transform">Процентное изменение</span> - относительное изменение в процентах между последовательными значениями.</li>
                        <li><span class="badge-transform">Логарифмическое изменение</span> - логарифм отношения текущего и предыдущего значений.</li>
                    </ul>
                </div>
                <div class="transforms-info">
                    <h4>Методы преобразования</h4>
                    <ul>
                        <li><span class="badge-transform">Простое дифференцирование</span> - метод вычисления изменений между последовательными наблюдениями.</li>
                        <li><span class="badge-transform">Процентное изменение</span> - измерение относительного изменения в процентах между последовательными значениями.</li>
                        <li><span class="badge-transform">Log-дифференцирование</span> - логарифм отношения текущего и предыдущего значений, приближение к процентному изменению.</li>
                        <li><span class="badge-transform">Box-Cox</span> - параметрическое преобразование, нормализующее данные и стабилизирующее дисперсию.</li>
                        <li><span class="badge-transform">Yeo-Johnson</span> - расширение Box-Cox для поддержки отрицательных значений.</li>
                        <li><span class="badge-transform">Ранговая нормализация</span> - непараметрическое преобразование, приводящее ряд к нормальному распределению.</li>
                        <li><span class="badge-transform">Экстремальное</span> - автоматический многоэтапный процесс нормализации, дифференцирования и винсоризации для оптимальных результатов.</li>
                    </ul>
                </div>

                <!-- Переключатель режима отображения -->
                <div class="display-toggle">
                    <span class="display-toggle-label">Режим отображения после преобразования:</span>
                    <div class="toggle-options">
                        <label class="toggle-option">
                            <input type="radio" name="displayMode" id="displayModeAll" value="all" checked>
                            Все ряды
                        </label>
                        <label class="toggle-option">
                            <input type="radio" name="displayMode" id="displayModeTransformed" value="transformed">
                            Только преобразованные ряды
                        </label>
                        <label class="toggle-option">
                            <input type="radio" name="displayMode" id="displayModeOriginal" value="original">
                            Только исходные ряды
                        </label>
                    </div>
                </div>

                <!-- Настройки преобразования -->
                <div class="transformation-card">
                    <div class="transformation-header">
                        <h3><i class="fas fa-magic"></i> Настройки преобразования</h3>
                    </div>
                    <div class="transformation-content">
                        <p>Выберите переменные для преобразования и установите тип и метод трансформации для каждой из них. <span class="text-muted">Преобразованные данные будут добавлены в новых столбцах, исходные данные сохранятся.</span></p>
                        
                        <!-- Опция "Выбрать все переменные" -->
                        <div class="select-all-variables">
                            <input type="checkbox" id="selectAllCheckbox" class="transform-checkbox">
                            <label for="selectAllCheckbox">Выбрать все переменные</label>
                        </div>
                        
                        <!-- Список переменных -->
                        <div id="variablesList">
                            <!-- Сюда будут добавлены строки с переменными -->
                        </div>
                        
                        <!-- Панель действий -->
                        <div class="actions-panel">
                            <div class="left-actions">
                                <button id="clearTransformedBtn" class="btn btn-danger" style="display: none;">
                                    <i class="fas fa-trash"></i> Удалить преобразованные переменные
                                </button>
                            </div>
                            <div class="right-actions">
                                <button id="transformBtn" class="btn btn-primary" disabled>
                                    <i class="fas fa-magic"></i> Выполнить преобразование
                                </button>
                                <button id="downloadBtn" class="btn btn-secondary" disabled>
                                    <i class="fas fa-download"></i> Скачать результат
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Контейнер для предпросмотра графика -->
                <div id="previewChartContainer" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <h3 class="chart-title">Предпросмотр преобразования</h3>
                        <div class="chart-controls">
                            <button id="closePreviewBtn" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Закрыть
                            </button>
                        </div>
                    </div>
                    <div class="legend" id="previewLegend">
                        <!-- Легенда предпросмотра будет заполнена динамически -->
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="previewChart"></canvas>
                    </div>
                </div>

                <!-- Сообщение о результате преобразования -->
                <div id="transformAlert" class="alert alert-success alert-transformation" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="transformMessage">Преобразование успешно выполнено.</span>
                </div>
            </div>
        </main>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Модальное окно загрузки -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
               <div class="modal-body text-center p-4">
                   <div class="mb-3">
                       <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                           <span class="visually-hidden">Загрузка...</span>
                       </div>
                   </div>
                   <h5 id="loadingMessage">Обработка данных...</h5>
                   <p id="loadingDetails" class="text-muted">Пожалуйста, подождите. Это может занять несколько секунд.</p>
               </div>
           </div>
       </div>
   </div>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
   <script>
   document.addEventListener('DOMContentLoaded', function() {
       // API URL
       const API_URL = 'http://37.252.23.30:8000';
       
       // Обработка мобильного меню
       const sidebarToggle = document.getElementById('sidebarToggle');
       const sidebar = document.getElementById('sidebar');
       const sidebarOverlay = document.getElementById('sidebarOverlay');
       
       sidebarToggle.addEventListener('click', function() {
           sidebar.classList.toggle('active');
           sidebarOverlay.classList.toggle('active');
           document.body.classList.toggle('sidebar-open');
       });
       
       sidebarOverlay.addEventListener('click', function() {
           sidebar.classList.remove('active');
           sidebarOverlay.classList.remove('active');
           document.body.classList.remove('sidebar-open');
       });

       // Адаптивность при изменении размера окна
       window.addEventListener('resize', function() {
           if (window.innerWidth >= 992) {
               sidebar.classList.remove('active');
               sidebarOverlay.classList.remove('active');
               document.body.classList.remove('sidebar-open');
           }
       });
       
       // Режим отображения результатов
       let displayMode = 'all'; // По умолчанию показываем все ряды
       
       // Модальное окно загрузки
       const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
       const loadingMessage = document.getElementById('loadingMessage');
       const loadingDetails = document.getElementById('loadingDetails');
       
       // Элементы DOM для отображения информации о файле
       const fileInfoPanel = document.getElementById('fileInfoPanel');
       const fileName = document.getElementById('fileName');
       const fileDetails = document.getElementById('fileDetails');
       const noDataMessage = document.getElementById('noDataMessage');
       const transformationContent = document.getElementById('transformationContent');
       const backToDataBtn = document.getElementById('backToDataBtn');
       
       // Элементы DOM для преобразования
       const variablesList = document.getElementById('variablesList');
       const selectAllCheckbox = document.getElementById('selectAllCheckbox');
       const transformBtn = document.getElementById('transformBtn');
       const downloadBtn = document.getElementById('downloadBtn');
       const clearTransformedBtn = document.getElementById('clearTransformedBtn');
       const transformAlert = document.getElementById('transformAlert');
       const transformMessage = document.getElementById('transformMessage');
       
       // Глобальные переменные
       let fileData = null;
       let selectedVariables = [];
       let transformedData = null;
       let chartColors = [
           '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
           '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#a855f7'
       ];
       
       // Обработчики переключения режима отображения
       document.getElementById('displayModeAll').addEventListener('change', function() {
           if(this.checked) {
               displayMode = 'all';
               filterVariablesList(displayMode);
               updateDownloadButtonVisibility();
           }
       });
       
       document.getElementById('displayModeTransformed').addEventListener('change', function() {
           if(this.checked) {
               displayMode = 'transformed';
               filterVariablesList(displayMode);
               updateDownloadButtonVisibility();
           }
       });
       
       document.getElementById('displayModeOriginal').addEventListener('change', function() {
           if(this.checked) {
               displayMode = 'original';
               filterVariablesList(displayMode);
               updateDownloadButtonVisibility();
           }
       });
       
       // Функция для управления видимостью кнопки "Скачать результат"
       function updateDownloadButtonVisibility() {
           if (displayMode === 'original') {
               downloadBtn.style.display = 'none';
           } else {
               downloadBtn.style.display = transformedData ? 'inline-flex' : 'inline-flex';
           }
       }
       
       // Функция для фильтрации списка переменных в зависимости от режима отображения
       function filterVariablesList(mode) {
           const variableRows = document.querySelectorAll('.variable-row');
           
           variableRows.forEach(row => {
               // Находим имя переменной из селекта
               const selectElement = row.querySelector('.integration-order');
               if (!selectElement) return;
               
               const variableName = selectElement.dataset.variable;
               if (!variableName) return;
               
               // Определяем тип переменной по имени
               let isTransformed = false;
               let isOriginal = true;
               
               // Проверяем, является ли переменная преобразованной
               if (variableName.includes('_I0') || variableName.includes('_I1') || variableName.includes('_I2') ||
                   variableName.includes('_norm') || variableName.includes('_boxcox') || 
                   variableName.includes('_yeojohnson') || variableName.includes('_rank')) {
                   isTransformed = true;
                   isOriginal = false;
               }
               
               // Показываем/скрываем строку в зависимости от режима
               switch(mode) {
                   case 'all':
                       row.style.display = 'flex';
                       break;
                   case 'transformed':
                       row.style.display = isTransformed ? 'flex' : 'none';
                       break;
                   case 'original':
                       row.style.display = isOriginal ? 'flex' : 'none';
                       break;
                   default:
                       row.style.display = 'flex';
               }
           });
           
           // Обновляем чекбокс "Выбрать все"
           updateSelectAllCheckbox();
       }
       
       // Функция для обновления состояния чекбокса "Выбрать все"
       function updateSelectAllCheckbox() {
           const visibleCheckboxes = Array.from(document.querySelectorAll('.variable-row:not([style*="display: none"]) .transform-checkbox'));
           const checkedVisibleCheckboxes = visibleCheckboxes.filter(cb => cb.checked && cb.id !== 'selectAllCheckbox');
           
           selectAllCheckbox.checked = visibleCheckboxes.length > 0 && 
                                      checkedVisibleCheckboxes.length === visibleCheckboxes.length;
           selectAllCheckbox.indeterminate = checkedVisibleCheckboxes.length > 0 && 
                                            checkedVisibleCheckboxes.length < visibleCheckboxes.length;
       }
       
       // Проверяем, есть ли загруженный файл
       checkLoadedFile();
       
       // Слушатель для кнопки "К списку данных"
       backToDataBtn.addEventListener('click', function() {
           window.location.href = '/data';
       });
       
       // Слушатель для чекбокса "Выбрать все"
       selectAllCheckbox.addEventListener('change', function() {
           const visibleCheckboxes = document.querySelectorAll('.variable-row:not([style*="display: none"]) .transform-checkbox');
           visibleCheckboxes.forEach(checkbox => {
               if (checkbox.id !== 'selectAllCheckbox') {
                   checkbox.checked = selectAllCheckbox.checked;
               }
           });
           updateSelectedVariables();
       });
       
       // Слушатель для кнопки преобразования
       transformBtn.addEventListener('click', transformData);
       
       // Слушатель для кнопки скачивания
       downloadBtn.addEventListener('click', downloadTransformedData);
       
       // Слушатель для кнопки удаления преобразованных переменных
       clearTransformedBtn.addEventListener('click', clearTransformedVariables);
       
       // Функция проверки наличия загруженного файла
       function checkLoadedFile() {
           const storedFileId = localStorage.getItem('fileId');
           const storedFileName = localStorage.getItem('fileName');
           const storedColumnsData = localStorage.getItem('fileColumnsData');
           const originalFileId = localStorage.getItem('originalFileId');
           
           if (storedFileId && storedFileName && storedColumnsData) {
               // Есть загруженный файл
               fileInfoPanel.style.display = 'flex';
               noDataMessage.style.display = 'none';
               transformationContent.style.display = 'block';
               
               // Отображаем информацию о файле
               fileName.textContent = storedFileName;
               
               try {
                   fileData = JSON.parse(storedColumnsData);
                   fileData.fileId = storedFileId;
                   
                   const numericColumns = fileData.numeric_columns || [];
                   const rowsCount = fileData.rows_count || 0;
                   
                   fileDetails.textContent = `${numericColumns.length} числовых столбцов, ${rowsCount} наблюдений`;
                   
                   // Проверяем, есть ли преобразованные данные
                   if (originalFileId && originalFileId !== storedFileId) {
                       // Есть преобразованные данные, показываем кнопку удаления
                       clearTransformedBtn.style.display = 'inline-flex';
                       downloadBtn.disabled = false;
                       transformedData = { download_url: `http://37.252.23.30:8000/temp-file/${storedFileId}` };
                   }
                   
                   // Заполняем список переменных
                   populateVariablesList();
                   
               } catch (error) {
                   console.error('Ошибка при разборе данных о столбцах:', error);
                   fileDetails.textContent = 'Файл загружен';
               }
           } else {
               // Нет загруженного файла
               fileInfoPanel.style.display = 'none';
               noDataMessage.style.display = 'block';
               transformationContent.style.display = 'none';
           }
       }
       
       // Функция для заполнения списка переменных
       function populateVariablesList() {
           variablesList.innerHTML = ''; // Очищаем список
           
           const numericColumns = fileData.numeric_columns || [];
           
           // Для каждой колонки создаем строку в таблице
           numericColumns.forEach(column => {
               // Пропускаем колонку с датами
               if (column === fileData.date_column) {
                   return;
               }
               
               // Создаем строку с переменной
               const row = document.createElement('div');
               row.className = 'variable-row';
               
               // Название переменной
               const nameDiv = document.createElement('div');
               nameDiv.className = 'variable-name';
               nameDiv.textContent = column;
               
               // Статус переменной (порядок интеграции или тип преобразования)
               const statusDiv = document.createElement('div');
               statusDiv.className = 'variable-status';
               
               // Определение текущего статуса на основе имени
               let statusBadge = "";
               
               if (column.endsWith("_I0")) {
                   statusBadge = '<span class="status-badge stationary">I(0)</span>';
               } else if (column.endsWith("_I1")) {
                   statusBadge = '<span class="status-badge non-stationary">I(1)</span>';
               } else if (column.endsWith("_I2")) {
                   statusBadge = '<span class="status-badge non-stationary">I(2)</span>';
               } else if (column.includes("_norm") || column.includes("_boxcox") || column.includes("_yeojohnson")) {
                   statusBadge = '<span class="status-badge normalized">Нормализованный</span>';
               } else {
                   statusBadge = '<span class="text-muted">Исходный</span>';
               }
               
               statusDiv.innerHTML = statusBadge;
               
               // Опции преобразования
               const optionsDiv = document.createElement('div');
               optionsDiv.className = 'transformation-options';
               
               // Селект с типом преобразования
               const selectWrapper = document.createElement('div');
               selectWrapper.className = 'select-wrapper';
               
               const select = document.createElement('select');
               select.className = 'integration-order';
               select.dataset.variable = column;
               
               // Опции для селекта с типами преобразования
                const options = [
                    { value: 'none', text: 'Оставить как есть' },
                    { value: 'I(1)', text: 'Интеграция 1-го порядка - I(1)' },
                    { value: 'I(2)', text: 'Интеграция 2-го порядка - I(2)' },
                    { value: 'I(3)', text: 'Интеграция 3-го порядка - I(3)' },
                    { value: 'I(4)', text: 'Интеграция 4-го порядка - I(4)' },
                    { value: 'normalize', text: 'Нормализация' }
                ];
               
               options.forEach(opt => {
                   const option = document.createElement('option');
                   option.value = opt.value;
                   option.textContent = opt.text;
                   select.appendChild(option);
               });
               
               // Добавляем селект с методом преобразования
               const methodWrapper = document.createElement('div');
               methodWrapper.className = 'select-wrapper diff-method-wrapper';
               methodWrapper.dataset.variable = column;
               methodWrapper.style.display = 'none'; // По умолчанию скрыт
               
               const methodSelect = document.createElement('select');
               methodSelect.className = 'diff-method';
               methodSelect.dataset.variable = column;
               
               // Обработчик изменения типа преобразования
                select.addEventListener('change', function() {
                    const selectedType = this.value;
                    
                    // Показываем селект с методом в зависимости от выбранного типа
                    if (['I(1)', 'I(2)', 'I(3)', 'I(4)', 'normalize'].includes(selectedType)) {
                        methodWrapper.style.display = 'block';
                        
                        // Очищаем текущие опции
                        methodSelect.innerHTML = '';
                        
                        // Добавляем подходящие методы в зависимости от выбранного типа преобразования
                        if (['I(1)', 'I(2)', 'I(3)', 'I(4)'].includes(selectedType)) {
                            // Методы для дифференцирования (интеграции обратно)
                            [
                                { value: 'simple', text: 'Простое дифференцирование' },
                                { value: 'percentage', text: 'Процентное изменение' },
                                { value: 'log', text: 'Логарифмическое изменение' }
                            ].forEach(method => {
                                const option = document.createElement('option');
                                option.value = method.value;
                                option.textContent = method.text;
                                methodSelect.appendChild(option);
                            });
                        } else if (selectedType === 'normalize') {
                            // Методы для нормализации
                            [
                                { value: 'boxcox', text: 'Преобразование Бокса-Кокса' },
                                { value: 'yeojohnson', text: 'Преобразование Йео-Джонсона' },
                                { value: 'rank', text: 'Ранговая нормализация' },
                                { value: 'auto', text: 'Автоматический выбор метода' },
                                { value: 'extreme', text: 'Экстремальная нормализация' }
                            ].forEach(method => {
                                const option = document.createElement('option');
                                option.value = method.value;
                                option.textContent = method.text;
                                methodSelect.appendChild(option);
                            });
                        }
                    } else {
                        methodWrapper.style.display = 'none';
                    }
                });
               
               selectWrapper.appendChild(select);
               methodWrapper.appendChild(methodSelect);
               
               // Чекбокс для выбора
               const checkboxWrapper = document.createElement('div');
               checkboxWrapper.className = 'checkbox-wrapper';
               
               const checkbox = document.createElement('input');
               checkbox.type = 'checkbox';
               checkbox.className = 'transform-checkbox';
               checkbox.id = `transform_${column}`;
               checkbox.dataset.variable = column;
               checkbox.addEventListener('change', updateSelectedVariables);
               
               const label = document.createElement('label');
               label.setAttribute('for', `transform_${column}`);
               label.textContent = 'Выбрать';
               
               checkboxWrapper.appendChild(checkbox);
               checkboxWrapper.appendChild(label);
               
               // Добавляем элементы в строку
               optionsDiv.appendChild(selectWrapper);
               optionsDiv.appendChild(methodWrapper);
               optionsDiv.appendChild(checkboxWrapper);
               
               row.appendChild(nameDiv);
               row.appendChild(statusDiv);
               row.appendChild(optionsDiv);
               
               // Добавляем строку в список
               variablesList.appendChild(row);
           });
           
           // Если нет числовых переменных
           if (numericColumns.length === 0 || numericColumns.length === 1 && numericColumns[0] === fileData.date_column) {
               const noVarsMsg = document.createElement('div');
               noVarsMsg.className = 'text-center p-4 text-muted';
               noVarsMsg.innerHTML = '<i class="fas fa-exclamation-circle mb-2"></i><p>Нет числовых переменных для преобразования</p>';
               variablesList.appendChild(noVarsMsg);
           }
           
           // Применяем текущий фильтр
           filterVariablesList(displayMode);
       }
       
       // Функция для обновления списка выбранных переменных
       function updateSelectedVariables() {
           selectedVariables = [];
           const visibleCheckboxes = document.querySelectorAll('.variable-row:not([style*="display: none"]) .transform-checkbox');
           
           visibleCheckboxes.forEach(checkbox => {
               const variable = checkbox.dataset.variable;
               if (variable && checkbox.id !== 'selectAllCheckbox') {
                   if (checkbox.checked) {
                       selectedVariables.push(variable);
                   }
               }
           });
           
           // Обновляем состояние кнопки преобразования
           transformBtn.disabled = selectedVariables.length === 0;
           
           // Обновляем состояние чекбокса "Выбрать все"
           updateSelectAllCheckbox();
           
           console.log('Выбранные переменные:', selectedVariables);
       }
       
       // Функция для сбора настроек преобразования
       function getTransformationSettings() {
           const settings = {};
           
           selectedVariables.forEach(variable => {
               const selectEl = document.querySelector(`select.integration-order[data-variable="${variable}"]`);
               if (selectEl) {
                   const transformType = selectEl.value;
                   
                   // Получаем метод преобразования, если доступен
                   const methodEl = document.querySelector(`select.diff-method[data-variable="${variable}"]`);
                   const methodValue = methodEl && methodEl.style.display !== 'none' ? methodEl.value : 'simple';
                   
                   // Если выбрана нормализация, меняем формат данных
                   if (transformType === 'normalize') {
                       settings[variable] = {
                           transformTo: 'normalize',
                           diffMethod: methodValue
                       };
                   } else {
                       settings[variable] = {
                           transformTo: transformType,
                           diffMethod: methodValue
                       };
                   }
               }
           });
           
           return settings;
       }
       
        // Функция для удаления преобразованных переменных
        async function clearTransformedVariables() {
            if (!confirm('Вы уверены, что хотите удалить все преобразованные переменные? Это действие нельзя отменить.')) {
                return;
            }
            
            // Показываем модальное окно загрузки
            loadingMessage.textContent = 'Удаление преобразованных переменных...';
            loadingDetails.textContent = 'Пожалуйста, подождите...';
            loadingModal.show();
            
            // Создаем промис для задержки
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            
            try {
                // Минимальная задержка для показа окна загрузки
                await delay(500);
                
                // Получаем исходный file_id из localStorage
                const originalFileId = localStorage.getItem('originalFileId');
                const originalColumnsData = localStorage.getItem('originalFileColumnsData');
                
                if (originalFileId && originalColumnsData) {
                    // Восстанавливаем исходные данные
                    localStorage.setItem('fileId', originalFileId);
                    localStorage.setItem('fileColumnsData', originalColumnsData);
                    
                    // Обновляем fileData
                    fileData = JSON.parse(originalColumnsData);
                    fileData.fileId = originalFileId;
                    
                    // Очищаем данные о преобразовании
                    transformedData = null;
                    
                    // Удаляем сохраненные данные о преобразовании
                    localStorage.removeItem('originalFileId');
                    localStorage.removeItem('originalFileColumnsData');
                    
                    // Обновляем информацию о файле
                    const numericColumns = fileData.numeric_columns || [];
                    const rowsCount = fileData.rows_count || 0;
                    fileDetails.textContent = `${numericColumns.length} числовых столбцов, ${rowsCount} наблюдений`;
                    
                    // Перезагружаем список переменных
                    populateVariablesList();
                    
                    // Скрываем кнопку удаления и скачивания
                    clearTransformedBtn.style.display = 'none';
                    downloadBtn.disabled = true;
                    
                    // Небольшая задержка перед закрытием окна
                    await delay(1000);
                    
                    // Закрываем модальное окно
                    loadingModal.hide();
                    
                    // Показываем сообщение об успехе
                    transformMessage.textContent = 'Преобразованные переменные успешно удалены.';
                    transformAlert.className = 'alert alert-success alert-transformation';
                    transformAlert.style.display = 'block';
                    
                    // Автоматически скрываем сообщение через 5 секунд
                    setTimeout(() => {
                        transformAlert.style.display = 'none';
                    }, 5000);
                    
                } else {
                    throw new Error('Не найдены исходные данные файла');
                }
                
            } catch (error) {
                console.error('Ошибка при удалении преобразованных переменных:', error);
                
                // Закрываем модальное окно
                loadingModal.hide();
                
                transformMessage.textContent = `Ошибка при удалении преобразованных переменных: ${error.message}`;
                transformAlert.className = 'alert alert-danger alert-transformation';
                transformAlert.style.display = 'block';
                
                // Автоматически скрываем сообщение об ошибке через 5 секунд
                setTimeout(() => {
                    transformAlert.style.display = 'none';
                }, 5000);
            }
        }
       
       // Функция для преобразования данных
       async function transformData() {
           if (selectedVariables.length === 0) {
               alert('Пожалуйста, выберите хотя бы одну переменную для преобразования.');
               return;
           }
           
           // Сохраняем исходные данные перед преобразованием
           if (!localStorage.getItem('originalFileId')) {
               localStorage.setItem('originalFileId', fileData.fileId);
               localStorage.setItem('originalFileColumnsData', JSON.stringify(fileData));
           }
           
           // Показываем модальное окно загрузки
           loadingMessage.textContent = 'Преобразование данных...';
           loadingDetails.textContent = 'Выполняется преобразование временных рядов...';
           loadingModal.show();
           
           try {
               // Получаем настройки преобразования
               const transformationSettings = getTransformationSettings();
               
               // Готовим данные для запроса
               const fileId = fileData.fileId;
               const dateColumn = fileData.date_column || 'Дата';
               
               // Запрос к API для преобразования
               const formData = new FormData();
               formData.append('file_id', fileId);
               formData.append('date_column', dateColumn);
               formData.append('transformation_settings', JSON.stringify(transformationSettings));
               formData.append('preview', 'false');
               formData.append('display_mode', displayMode);
               
               // Отправляем запрос на трансформацию
               const response = await fetch(`${API_URL}/transform-integration-order`, {
                   method: 'POST',
                   body: formData
               });
               
               if (!response.ok) {
                   throw new Error('Ошибка при преобразовании данных');
               }
               
               const result = await response.json();
               console.log('Результат преобразования:', result);
               
               // Сохраняем результат для дальнейшего использования
               transformedData = result;
               
               // Обновляем localStorage с новыми данными
               if (result.updated_file_id) {
                   localStorage.setItem('fileId', result.updated_file_id);
                   // Обновляем fileData для последующих операций
                   fileData.fileId = result.updated_file_id;
               }
               
               if (result.updated_columns_data) {
                   localStorage.setItem('fileColumnsData', JSON.stringify(result.updated_columns_data));
               }
               
               // Активируем кнопку скачивания и показываем кнопку удаления
               downloadBtn.disabled = false;
               clearTransformedBtn.style.display = 'inline-flex';
               
               // Показываем сообщение об успехе
               transformMessage.textContent = 'Преобразование успешно выполнено. Вы можете скачать новый файл или продолжить работу с преобразованными данными.';
               transformAlert.className = 'alert alert-success alert-transformation';
               transformAlert.style.display = 'block';
               
               // Обновляем интерфейс с новыми данными
               if (result.updated_columns_data) {
                   fileData = result.updated_columns_data;
                   fileData.fileId = result.updated_file_id || fileData.fileId;
                   
                   // Обновляем информацию о файле
                   const numericColumns = fileData.numeric_columns || [];
                   const rowsCount = fileData.rows_count || 0;
                   fileDetails.textContent = `${numericColumns.length} числовых столбцов, ${rowsCount} наблюдений`;
                   
                   // Перезагружаем список переменных
                   populateVariablesList();
               }
               
               // Обновляем видимость кнопки скачивания
               updateDownloadButtonVisibility();
               
           } catch (error) {
               console.error('Ошибка при преобразовании данных:', error);
               transformMessage.textContent = `Ошибка при преобразовании данных: ${error.message}`;
               transformAlert.className = 'alert alert-danger alert-transformation';
               transformAlert.style.display = 'block';
           } finally {
               // Скрываем модальное окно загрузки
               loadingModal.hide();
           }
       }
       
       // Функция для скачивания преобразованных данных
       async function downloadTransformedData() {
           if (!transformedData || !transformedData.download_url) {
               alert('Нет данных для скачивания. Сначала выполните преобразование.');
               return;
           }
           
           try {
               // Создаем ссылку для скачивания
               const downloadLink = document.createElement('a');
               downloadLink.href = transformedData.download_url;
               downloadLink.download = `transformed_${fileName.textContent}`;
               downloadLink.style.display = 'none';
               document.body.appendChild(downloadLink);
               downloadLink.click();
               document.body.removeChild(downloadLink);
           } catch (error) {
               console.error('Ошибка при скачивании файла:', error);
               alert(`Ошибка при скачивании файла: ${error.message}`);
           }
       }
   });
   </script>
</body>
</html>
